Phsar_One Database Schema (from supabase/migrations)

Tables and Attributes

1) public.users
- id text PRIMARY KEY
- email text UNIQUE NOT NULL
- first_name text
- last_name text
- avatar_url text
- phone text
- user_type text DEFAULT 'regular' CHECK (user_type IN ('regular','starter','pro','business'))
- created_at timestamptz DEFAULT now()
- updated_at timestamptz DEFAULT now()
- last_online_at timestamptz

2) public.categories
- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
- name_key text NOT NULL
- icon_name text
- parent_id uuid REFERENCES public.categories(id) ON DELETE CASCADE
- slug text UNIQUE
- created_at timestamptz DEFAULT now()
- updated_at timestamptz DEFAULT now()

3) public.products
- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
- seller_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- category_id uuid REFERENCES public.categories(id) ON DELETE SET NULL
- title text NOT NULL
- description text
- price numeric NOT NULL CHECK (price >= 0)
- is_negotiable boolean DEFAULT false
- metadata jsonb DEFAULT '{}'::jsonb
- images text[] DEFAULT '{}'
- location_name text
- status text DEFAULT 'active' CHECK (status IN ('active','traded','hidden','expired','draft'))
- created_at timestamptz DEFAULT now()
- updated_at timestamptz DEFAULT now()

4) public.trades
- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
- owner_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- category_id uuid REFERENCES public.categories(id) ON DELETE SET NULL
- title text NOT NULL
- description text
- images text[] DEFAULT '{}'
- metadata jsonb DEFAULT '{}'::jsonb
- looking_for text
- cash_adjustment numeric DEFAULT 0
- location_name text
- status text DEFAULT 'active' CHECK (status IN ('active','traded','hidden','expired','draft'))
- created_at timestamptz DEFAULT now()
- updated_at timestamptz DEFAULT now()

5) public.conversations
- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
- product_id uuid REFERENCES public.products(id) ON DELETE SET NULL
- trade_id uuid REFERENCES public.trades(id) ON DELETE SET NULL
- buyer_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- seller_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- created_at timestamptz DEFAULT now()
- updated_at timestamptz DEFAULT now()
- buyer_muted boolean DEFAULT false
- seller_muted boolean DEFAULT false
- UNIQUE INDEX (product_id, buyer_id, seller_id) WHERE product_id IS NOT NULL
- UNIQUE INDEX (trade_id, buyer_id, seller_id) WHERE trade_id IS NOT NULL

6) public.messages
- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
- conversations_id uuid NOT NULL REFERENCES public.conversations(id) ON DELETE CASCADE
- sender_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- content jsonb NOT NULL  (originally text, migrated to jsonb)
- is_read boolean DEFAULT false
- created_at timestamptz DEFAULT now()

7) public.favorites
- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
- user_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- product_id uuid REFERENCES public.products(id) ON DELETE CASCADE
- trade_id uuid REFERENCES public.trades(id) ON DELETE CASCADE
- created_at timestamptz DEFAULT now()
- CHECK (product_id IS NOT NULL OR trade_id IS NOT NULL)
- UNIQUE (user_id, product_id)
- UNIQUE (user_id, trade_id)

8) public.subscriptions
- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
- user_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- plan_type text CHECK (plan_type IN ('starter','pro','business'))
- status text DEFAULT 'inactive' CHECK (status IN ('active','trailing','past_due','canceled','inactive','pending_verification'))
- payment_provider text
- external_id text UNIQUE
- payment_proof_url text
- current_period_end timestamptz
- created_at timestamptz DEFAULT now()
- updated_at timestamptz DEFAULT now()

9) public.follows
- follower_id text REFERENCES public.users(id) ON DELETE CASCADE
- following_id text REFERENCES public.users(id) ON DELETE CASCADE
- created_at timestamptz DEFAULT now()
- PRIMARY KEY (follower_id, following_id)
- CHECK (follower_id <> following_id)

10) public.view_history
- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
- user_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- product_id uuid REFERENCES public.products(id) ON DELETE CASCADE
- trade_id uuid REFERENCES public.trades(id) ON DELETE CASCADE
- viewed_at timestamptz DEFAULT now()
- CHECK (product_id IS NOT NULL OR trade_id IS NOT NULL)

11) public.analytics_views
- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
- product_id uuid REFERENCES public.products(id) ON DELETE CASCADE
- trade_id uuid REFERENCES public.trades(id) ON DELETE CASCADE
- viewer_id text
- created_at timestamptz DEFAULT now()

12) public.trade_offers
- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
- trade_id uuid NOT NULL REFERENCES public.trades(id) ON DELETE CASCADE
- bidder_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- offered_item_desc text NOT NULL
- cash_adjustment numeric DEFAULT 0
- status text DEFAULT 'pending' CHECK (status IN ('pending','accepted','declined','cancelled'))
- created_at timestamptz DEFAULT now()
- updated_at timestamptz DEFAULT now()

13) public.notifications
- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
- user_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- type text NOT NULL
- title text NOT NULL
- body text NOT NULL
- data jsonb
- is_read boolean DEFAULT false
- created_at timestamptz DEFAULT now()

14) public.reviews
- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
- reviewer_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- target_user_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- product_id uuid REFERENCES public.products(id) ON DELETE SET NULL
- rating integer CHECK (rating >= 1 AND rating <= 5)
- comment text
- created_at timestamptz DEFAULT now()
- CHECK (reviewer_id <> target_user_id)

15) public.reports
- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
- reporter_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- target_user_id text REFERENCES public.users(id) ON DELETE CASCADE
- target_product_id uuid REFERENCES public.products(id) ON DELETE SET NULL
- reason text NOT NULL
- status text DEFAULT 'pending' CHECK (status IN ('pending','reviewed','resolved'))
- created_at timestamptz DEFAULT now()
- CHECK (target_user_id IS NOT NULL OR target_product_id IS NOT NULL)

16) public.blocked_users
- blocker_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- blocked_id text NOT NULL REFERENCES public.users(id) ON DELETE CASCADE
- created_at timestamptz DEFAULT now()
- PRIMARY KEY (blocker_id, blocked_id)
- CHECK (blocker_id <> blocked_id)

Views

1) public.conversation_summaries
- Built from public.conversations and public.messages
- Adds derived fields:
  - last_message_content
  - last_message_at
  - last_message_sender_id
  - unread_count

Relationship Map (Where each connects)

- categories.parent_id -> categories.id (self-referencing tree)
- products.seller_id -> users.id
- products.category_id -> categories.id
- trades.owner_id -> users.id
- trades.category_id -> categories.id
- conversations.product_id -> products.id
- conversations.trade_id -> trades.id
- conversations.buyer_id -> users.id
- conversations.seller_id -> users.id
- messages.conversations_id -> conversations.id
- messages.sender_id -> users.id
- favorites.user_id -> users.id
- favorites.product_id -> products.id
- favorites.trade_id -> trades.id
- subscriptions.user_id -> users.id
- follows.follower_id -> users.id
- follows.following_id -> users.id
- view_history.user_id -> users.id
- view_history.product_id -> products.id
- view_history.trade_id -> trades.id
- analytics_views.product_id -> products.id
- analytics_views.trade_id -> trades.id
- trade_offers.trade_id -> trades.id
- trade_offers.bidder_id -> users.id
- notifications.user_id -> users.id
- reviews.reviewer_id -> users.id
- reviews.target_user_id -> users.id
- reviews.product_id -> products.id
- reports.reporter_id -> users.id
- reports.target_user_id -> users.id
- reports.target_product_id -> products.id
- blocked_users.blocker_id -> users.id
- blocked_users.blocked_id -> users.id

Notes
- Storage migration sets up buckets/policies in storage schema but does not add new application tables in public schema.
- Triggers/functions exist for timestamps and user/subscription activity, but they do not introduce extra table relationships beyond the foreign keys above.
